generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// 角色 enum
// ============================================================

enum Role {
  MEMBER // 一般會員（預設）
  ADMIN  // 組織者（手動在資料庫設定）
}

// ============================================================
// User — 使用者（我們自己的 + NextAuth 需要的欄位）
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? // 【NextAuth 需要】Email 驗證時間
  image         String?   // 【NextAuth 需要】Google 頭像 URL
  role          Role      @default(MEMBER) // 【自訂】使用者角色
  points        Int       @default(0)      // 【自訂】累積積分
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 關聯：一個 User 可以有多個 OAuth 帳號連結和多個 Session
  accounts Account[]
  sessions Session[]

  // 【event-crud】一個組織者可以建立多個活動
  events Event[]

  // 【event-registration】一個使用者可以報名多個活動
  registrations Registration[]
}

// ============================================================
// 活動狀態 enum
// ============================================================

enum EventStatus {
  DRAFT      // 草稿（組織者建立後的初始狀態，公開頁面看不到）
  PUBLISHED  // 已發布（出現在公開活動列表）
  ENDED      // 已結束（組織者手動標記，觸發積分發放）
  CANCELLED  // 已取消（從公開列表隱藏，取代硬刪除）
}

// ============================================================
// Event — 活動（我們的核心業務 model）
// ============================================================
// 由組織者（ADMIN）建立，參加者在公開列表瀏覽
// 生命週期：DRAFT → PUBLISHED → ENDED（或 CANCELLED）

model Event {
  id             String      @id @default(cuid())
  title          String                              // 活動標題
  description    String                              // 活動描述
  startTime      DateTime                            // 開始時間
  endTime        DateTime                            // 結束時間
  location       String                              // 地點
  capacity       Int                                 // 容量上限
  status         EventStatus @default(DRAFT)         // 活動狀態
  seekingSpeaker Boolean     @default(false)         // 是否徵求講者（為講者系統預留）
  organizerId    String                              // 建立者（→ User）
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // 關聯：活動由一位組織者建立
  organizer User @relation(fields: [organizerId], references: [id])

  // 【event-registration】一個活動可以被多人報名
  registrations Registration[]

  // 索引：公開列表頁會頻繁用 status 篩選 + startTime 排序
  @@index([status])
  @@index([startTime])
}

// ============================================================
// 報名狀態 enum
// ============================================================

enum RegistrationStatus {
  CONFIRMED // 已報名（報名成功的狀態）
  CANCELLED // 已取消（soft delete，保留記錄供分析）
}

// ============================================================
// Registration — 活動報名（User ↔ Event 的 explicit 多對多）
// ============================================================
// 同一組 userId + eventId 只會有一筆記錄。
// 取消報名 = 更新 status 為 CANCELLED（不是新增一筆）
// 重新報名 = 更新 status 回 CONFIRMED（不是再新增一筆）

model Registration {
  id        String             @id @default(cuid())
  userId    String                                      // 報名者（→ User）
  eventId   String                                      // 報名的活動（→ Event）
  status    RegistrationStatus @default(CONFIRMED)      // 報名狀態
  createdAt DateTime           @default(now())           // 首次報名時間
  updatedAt DateTime           @updatedAt                // 最後更新時間（取消/重新報名）

  // 關聯
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // 同一人對同一活動只能有一筆報名記錄
  @@unique([userId, eventId])

  // 查詢優化：常需要查「某活動的所有 CONFIRMED 報名」
  @@index([eventId, status])
}

// ============================================================
// Account — OAuth 帳號連結（NextAuth 要求，格式固定）
// ============================================================
// 存放 Google OAuth 的 token 資訊
// 一個 User 可以連結多個 provider（我們只用 Google）

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String  // "oauth" | "oidc" | "email" 等
  provider          String  // "google"
  providerAccountId String  // Google 那邊的使用者 ID
  refresh_token     String? // 【注意】NextAuth 要求用 snake_case
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId]) // 同一個 provider 的帳號不能重複
}

// ============================================================
// Session — 登入 session 記錄（NextAuth 要求，格式固定）
// ============================================================
// 每次登入建立一筆，過期後自動清除

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique // 存在 cookie 裡的 token
  userId       String
  expires      DateTime // session 過期時間

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================
// VerificationToken — Email 驗證用（NextAuth 要求，格式固定）
// ============================================================
// 我們用 Google OAuth 不會用到，但 NextAuth Prisma Adapter 要求要有

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}
